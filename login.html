<<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Админка с ролями</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
#auth-form, #user-panel, #admin-panel, #welcome-message { margin-top: 20px; }
#user-panel, #admin-panel, #welcome-message { display: none; }
button { margin: 3px; }
.hidden { display: none; }
table { border-collapse: collapse; margin-top: 10px; }
td, th { border: 1px solid black; padding: 5px 10px; }
</style>
</head>
<body>

<h1 id="form-title">> РЕЖИМ: РЕГИСТРАЦИЯ</h1>

<div id="auth-form">
    <input id="username" placeholder="Логин"><br><br>
    <input type="password" id="password" placeholder="Пароль"><br><br>
    <div id="confirm-password-group">
        <input type="password" id="confirm-password" placeholder="Подтвердите пароль"><br><br>
        <select id="role-select">
            <option value="user">user</option>
        </select>
    </div>
    <button id="main-action-button">Зарегистрироваться</button>
    <button id="mode-toggle">Войти</button>
    <div id="message" style="color:red;"></div>
</div>

<div id="welcome-message"></div>

<div id="user-panel">
    <h2>Панель игрока</h2>
    <p>Баланс: <span id="user-balance">0</span></p>
    <button id="bonus-btn">Получить бонус +10</button>
</div>

<div id="admin-panel">
    <h2>Панель управления пользователями</h2>
    <table id="users-table">
        <tr><th>Логин</th><th>Роль</th><th>Баланс</th><th>Действия</th></tr>
    </table>
    <button id="reset-all">Сбросить всех пользователей</button>
</div>

<script>
window.onload = function() {
    const USERNAME_INPUT = document.getElementById('username');
    const PASSWORD_INPUT = document.getElementById('password');
    const CONFIRM_PASSWORD_INPUT = document.getElementById('confirm-password');
    const CONFIRM_PASSWORD_GROUP = document.getElementById('confirm-password-group');
    const ROLE_SELECT = document.getElementById('role-select');
    const MAIN_ACTION_BUTTON = document.getElementById('main-action-button');
    const MODE_TOGGLE_BUTTON = document.getElementById('mode-toggle');
    const MESSAGE_DISPLAY = document.getElementById('message');
    const AUTH_FORM = document.getElementById('auth-form');
    const WELCOME_MESSAGE = document.getElementById('welcome-message');
    const FORM_TITLE = document.getElementById('form-title');

    const USER_PANEL = document.getElementById('user-panel');
    const ADMIN_PANEL = document.getElementById('admin-panel');
    const USER_BALANCE = document.getElementById('user-balance');
    const USERS_TABLE = document.getElementById('users-table');
    const BONUS_BTN = document.getElementById('bonus-btn');
    const RESET_ALL_BTN = document.getElementById('reset-all');

    const USER_KEY = 'app_users';

    // Админ / owner
    const DEV_USERNAME = 'DenisKazakov';
    const DEV_PASSWORD_HASH = '5e884898da28047151d0e56f8dc6292773603d0d6aabbdd'; // hash для "password"
    const DEV_ROLE = 'owner';

    let authMode = 'register';
    let currentUser = null;

    async function hashString(str) {
        const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
        return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    function getUsers() {
        let data = localStorage.getItem(USER_KEY);
        return data ? JSON.parse(data) : {};
    }

    function saveUsers(users) {
        localStorage.setItem(USER_KEY, JSON.stringify(users));
    }

    async function registerUser(username, password, role='user') {
        let users = getUsers();
        if(users[username]){
            MESSAGE_DISPLAY.textContent = 'Пользователь уже существует!';
            return;
        }
        const hash = await hashString(password);
        users[username] = { passwordHash: hash, role: role, balance: 100 };
        saveUsers(users);
        MESSAGE_DISPLAY.style.color = 'green';
        MESSAGE_DISPLAY.textContent = 'Регистрация успешна! Теперь войдите.';
        toggleMode();
    }

    async function loginUser(username, password){
        const hash = await hashString(password);

        if(username === DEV_USERNAME && hash === DEV_PASSWORD_HASH){
            currentUser = { username: DEV_USERNAME, role: DEV_ROLE, balance: Infinity };
            MESSAGE_DISPLAY.style.color = 'green';
            MESSAGE_DISPLAY.textContent = `Добро пожаловать, ${DEV_ROLE}!`;
            showPanels();
            return;
        }

        let users = getUsers();
        if(!users[username]){
            MESSAGE_DISPLAY.style.color = 'red';
            MESSAGE_DISPLAY.textContent = 'Пользователь не найден.';
            return;
        }

        if(hash === users[username].passwordHash){
            currentUser = { username: username, role: users[username].role, balance: users[username].balance };
            MESSAGE_DISPLAY.style.color = 'green';
            MESSAGE_DISPLAY.textContent = `Вход успешен. Роль: ${currentUser.role}`;
            showPanels();
        } else {
            MESSAGE_DISPLAY.style.color = 'red';
            MESSAGE_DISPLAY.textContent = 'Неверный пароль.';
        }
    }

    function showPanels(){
        AUTH_FORM.style.display = 'none';
        WELCOME_MESSAGE.style.display = 'block';
        WELCOME_MESSAGE.textContent = `Привет, ${currentUser.username}! Роль: ${currentUser.role}`;

        if(currentUser.role === 'user') USER_PANEL.style.display = 'block';
        if(['moderator','admin','owner'].includes(currentUser.role)) {
            USER_PANEL.style.display = 'block';
            ADMIN_PANEL.style.display = 'block';
            renderUsersTable();
        }
    }

    function toggleMode(){
        if(authMode==='register'){
            authMode='login';
            FORM_TITLE.textContent = '> РЕЖИМ: ВХОД';
            MAIN_ACTION_BUTTON.textContent = 'ВОЙТИ';
            MODE_TOGGLE_BUTTON.textContent = 'РЕГИСТРАЦИЯ';
            CONFIRM_PASSWORD_GROUP.style.display='none';
        } else {
            authMode='register';
            FORM_TITLE.textContent = '> РЕЖИМ: РЕГИСТРАЦИЯ';
            MAIN_ACTION_BUTTON.textContent = 'ЗАРЕГИСТРИРОВАТЬСЯ';
            MODE_TOGGLE_BUTTON.textContent = 'ВХОД';
            CONFIRM_PASSWORD_GROUP.style.display='block';
            // Роль можно выбирать только для админа
            ROLE_SELECT.innerHTML = '';
            if(currentUser && ['admin','owner'].includes(currentUser.role)){
                ['user','moderator','admin'].forEach(r=>{
                    let opt = document.createElement('option'); opt.value=r; opt.text=r; ROLE_SELECT.appendChild(opt);
                });
            } else {
                ROLE_SELECT.innerHTML = '<option value="user">user</option>';
            }
        }
        MESSAGE_DISPLAY.textContent='';
        USERNAME_INPUT.value=''; PASSWORD_INPUT.value=''; CONFIRM_PASSWORD_INPUT.value='';
    }

    MAIN_ACTION_BUTTON.addEventListener('click', async function(e){
        e.preventDefault();
        const username = USERNAME_INPUT.value.trim();
        const password = PASSWORD_INPUT.value;
        if(!username || !password){ MESSAGE_DISPLAY.textContent='Заполните все поля'; return; }

        if(authMode==='register'){
            const confirm = CONFIRM_PASSWORD_INPUT.value;
            if(password !== confirm){ MESSAGE_DISPLAY.textContent='Пароли не совпадают'; return; }
            const role = ROLE_SELECT.value || 'user';
            await registerUser(username,password,role);
        } else { await loginUser(username,password); }
    });

    MODE_TOGGLE_BUTTON.addEventListener('click', function(e){ e.preventDefault(); toggleMode(); });

    BONUS_BTN.addEventListener('click', ()=>{
        currentUser.balance +=10;
        USER_BALANCE.textContent = currentUser.balance;
        // сохраняем
        if(currentUser.username !== DEV_USERNAME){
            let users = getUsers();
            users[currentUser.username].balance = currentUser.balance;
            saveUsers(users);
        }
    });

    function renderUsersTable(){
        USERS_TABLE.innerHTML='<tr><th>Логин</th><th>Роль</th><th>Баланс</th><th>Действия</th></tr>';
        let users = getUsers();
        if(currentUser.username !== DEV_USERNAME) users[DEV_USERNAME] = {role: DEV_ROLE, balance: '∞'}; // показать админа

        for(let u in users){
            let tr = document.createElement('tr');
            tr.innerHTML=`<td>${u}</td><td>${users[u].role}</td><td>${users[u].balance}</td>
            <td>
                <button onclick="changeRole('${u}')">Роль</button>
                <button onclick="deleteUser('${u}')">Удалить</button>
                <button onclick="addMoney('${u}',10)">+10 монет</button>
            </td>`;
            USERS_TABLE.appendChild(tr);
        }
    }

    window.changeRole = function(username){
        if(!['admin','owner'].includes(currentUser.role)) return alert('Нет доступа');
        let newRole = prompt('Введите новую роль (user/moderator/admin):');
        if(!newRole) return;
        let users = getUsers();
        if(users[username]) { users[username].role = newRole; saveUsers(users); renderUsersTable(); }
    }

    window.deleteUser = function(username){
        if(!['admin','owner'].includes(currentUser.role)) return alert('Нет доступа');
        let users = getUsers();
        delete users[username]; saveUsers(users); renderUsersTable();
    }

    window.addMoney = function(username, amount){
        let users = getUsers();
        if(users[username]) { users[username].balance += amount; saveUsers(users); renderUsersTable(); }
    }

    RESET_ALL_BTN.addEventListener('click', ()=>{
        if(!['owner'].includes(currentUser.role)) return alert('Только владелец может сбросить всех!');
        localStorage.removeItem(USER_KEY);
        USERS_TABLE.innerHTML='<tr><th>Логин</th><th>Роль</th><th>Баланс</th><th>Действия</th></tr>';
        alert('Все пользователи удалены!');
    });

    toggleMode();
};
</script>
</body>
</html>
